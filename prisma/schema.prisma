// Prisma Schema for Multi-Cloud Security Audit Dashboard

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?
  image         String?
  emailVerified DateTime?

  accounts           Account[]
  sessions           Session[]
  awsAccounts        AwsAccount[]
  gcpProjects        GcpProject[]
  azureSubscriptions AzureSubscription[]
  chatMessages       ChatMessage[]
  settings           UserSettings?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth Verification Token model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== AWS MODELS ====================

model AwsAccount {
  id              String    @id @default(cuid())
  name            String
  accountId       String
  accessKeyId     String?
  secretAccessKey String?
  roleArn         String?
  externalId      String?
  region          String    @default("us-east-1")
  isActive        Boolean   @default(true)
  lastScanAt      DateTime?
  healthScore     Float?

  // Schedule settings
  scheduleEnabled     Boolean   @default(false)
  scheduleFrequency   String?   // "daily" | "weekly" | "monthly"
  scheduleHour        Int?      // 0-23
  scheduleDayOfWeek   Int?      // 0-6 for weekly
  scheduleDayOfMonth  Int?      // 1-31 for monthly
  nextScheduledScan   DateTime?

  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  audits          AwsAudit[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, accountId])
}

model AwsAudit {
  id            String       @id @default(cuid())
  status        String       @default("pending")
  riskScore     Float?
  totalFindings Int          @default(0)
  critical      Int          @default(0)
  high          Int          @default(0)
  medium        Int          @default(0)
  low           Int          @default(0)
  duration      Int?
  errorMessage  String?

  accountId     String
  account       AwsAccount   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  phases        AwsPhase[]
  findings      AwsFinding[]

  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model AwsPhase {
  id           String       @id @default(cuid())
  phaseNumber  Int
  name         String
  status       String       @default("pending")
  findings     Int          @default(0)
  critical     Int          @default(0)
  high         Int          @default(0)
  medium       Int          @default(0)
  low          Int          @default(0)
  duration     Int?
  errorMessage String?

  auditId      String
  audit        AwsAudit     @relation(fields: [auditId], references: [id], onDelete: Cascade)

  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([auditId, phaseNumber])
}

model AwsFinding {
  id              String    @id @default(cuid())
  findingId       String
  severity        String
  title           String
  description     String?   @db.Text
  resource        String
  resourceType    String?
  resourceArn     String?
  region          String?
  recommendation  String?   @db.Text
  status          String    @default("open")
  resolvedAt      DateTime?

  auditId         String
  audit           AwsAudit  @relation(fields: [auditId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([auditId, severity])
  @@index([status])
}

// ==================== GCP MODELS ====================

model GcpProject {
  id                String    @id @default(cuid())
  name              String
  projectId         String
  projectNumber     String?
  serviceAccountKey String?   @db.Text
  region            String    @default("us-central1")
  isActive          Boolean   @default(true)
  lastScanAt        DateTime?
  healthScore       Float?

  // Schedule settings
  scheduleEnabled     Boolean   @default(false)
  scheduleFrequency   String?   // "daily" | "weekly" | "monthly"
  scheduleHour        Int?      // 0-23
  scheduleDayOfWeek   Int?      // 0-6 for weekly
  scheduleDayOfMonth  Int?      // 1-31 for monthly
  nextScheduledScan   DateTime?

  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  audits            GcpAudit[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([userId, projectId])
}

model GcpAudit {
  id            String       @id @default(cuid())
  status        String       @default("pending")
  riskScore     Float?
  totalFindings Int          @default(0)
  critical      Int          @default(0)
  high          Int          @default(0)
  medium        Int          @default(0)
  low           Int          @default(0)
  duration      Int?
  errorMessage  String?

  projectId     String
  project       GcpProject   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phases        GcpPhase[]
  findings      GcpFinding[]

  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model GcpPhase {
  id           String       @id @default(cuid())
  phaseNumber  Int
  name         String
  status       String       @default("pending")
  findings     Int          @default(0)
  critical     Int          @default(0)
  high         Int          @default(0)
  medium       Int          @default(0)
  low          Int          @default(0)
  duration     Int?
  errorMessage String?

  auditId      String
  audit        GcpAudit     @relation(fields: [auditId], references: [id], onDelete: Cascade)

  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([auditId, phaseNumber])
}

model GcpFinding {
  id              String    @id @default(cuid())
  findingId       String
  severity        String
  title           String
  description     String?   @db.Text
  resource        String
  resourceType    String?
  resourcePath    String?
  region          String?
  recommendation  String?   @db.Text
  status          String    @default("open")
  resolvedAt      DateTime?

  auditId         String
  audit           GcpAudit  @relation(fields: [auditId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([auditId, severity])
  @@index([status])
}

// ==================== AZURE MODELS ====================

model AzureSubscription {
  id              String    @id @default(cuid())
  name            String
  subscriptionId  String
  tenantId        String?
  clientId        String?
  clientSecret    String?
  region          String    @default("eastus")
  isActive        Boolean   @default(true)
  lastScanAt      DateTime?
  healthScore     Float?

  // Schedule settings
  scheduleEnabled     Boolean   @default(false)
  scheduleFrequency   String?   // "daily" | "weekly" | "monthly"
  scheduleHour        Int?      // 0-23
  scheduleDayOfWeek   Int?      // 0-6 for weekly
  scheduleDayOfMonth  Int?      // 1-31 for monthly
  nextScheduledScan   DateTime?

  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  audits          AzureAudit[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, subscriptionId])
}

model AzureAudit {
  id            String         @id @default(cuid())
  status        String         @default("pending")
  riskScore     Float?
  totalFindings Int            @default(0)
  critical      Int            @default(0)
  high          Int            @default(0)
  medium        Int            @default(0)
  low           Int            @default(0)
  duration      Int?
  errorMessage  String?

  subscriptionId String
  subscription   AzureSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  phases         AzurePhase[]
  findings       AzureFinding[]

  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model AzurePhase {
  id           String       @id @default(cuid())
  phaseNumber  Int
  name         String
  status       String       @default("pending")
  findings     Int          @default(0)
  critical     Int          @default(0)
  high         Int          @default(0)
  medium       Int          @default(0)
  low          Int          @default(0)
  duration     Int?
  errorMessage String?

  auditId      String
  audit        AzureAudit   @relation(fields: [auditId], references: [id], onDelete: Cascade)

  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([auditId, phaseNumber])
}

model AzureFinding {
  id              String     @id @default(cuid())
  findingId       String
  severity        String
  title           String
  description     String?    @db.Text
  resource        String
  resourceType    String?
  resourceId      String?
  region          String?
  recommendation  String?    @db.Text
  status          String     @default("open")
  resolvedAt      DateTime?

  auditId         String
  audit           AzureAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([auditId, severity])
  @@index([status])
}

// ==================== SHARED MODELS ====================

model UserSettings {
  id                    String    @id @default(cuid())

  // Spike.sh Integration
  spikeWebhookUrl       String?
  spikeEnabled          Boolean   @default(false)
  spikeAlertOnCritical  Boolean   @default(true)
  spikeAlertOnHigh      Boolean   @default(false)

  // Slack Integration
  slackWebhookUrl       String?
  slackEnabled          Boolean   @default(false)
  slackAlertOnCritical  Boolean   @default(true)
  slackAlertOnHigh      Boolean   @default(false)

  // Email Integration (via Resend)
  emailAddress          String?   // Override user email
  emailEnabled          Boolean   @default(false)
  emailAlertOnCritical  Boolean   @default(true)
  emailAlertOnHigh      Boolean   @default(false)

  // General notification preferences
  emailAlerts           Boolean   @default(true)
  alertThreshold        String    @default("CRITICAL") // CRITICAL, HIGH, MEDIUM, LOW

  userId                String    @unique
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model ChatMessage {
  id          String    @id @default(cuid())
  role        String
  content     String    @db.Text
  context     Json?

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
}

model AuditPhaseTemplate {
  id          String    @id @default(cuid())
  phaseNumber Int       @unique
  name        String
  description String?   @db.Text
  checks      Int       @default(0)
  category    String?
  cloudProvider String  @default("AWS") // AWS, GCP, AZURE

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ScheduledScanLog {
  id            String    @id @default(cuid())
  cloudProvider String    // "AWS" | "GCP" | "AZURE"
  accountId     String    // Reference ID to the account/project/subscription
  userId        String    // User who owns this schedule
  status        String    // "success" | "failed" | "skipped" | "running"
  auditId       String?   // Reference to the created audit (if successful)
  errorMessage  String?   @db.Text
  scheduledFor  DateTime
  executedAt    DateTime  @default(now())
  duration      Int?      // Duration in milliseconds

  @@index([cloudProvider, accountId])
  @@index([userId])
  @@index([status])
}
